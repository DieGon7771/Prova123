name: ğŸ” Prepare Files with API Key

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'production'
        type: choice
        options: [production, staging]

jobs:
  prepare-files:
    runs-on: ubuntu-latest
    outputs:
      files_ready: ${{ steps.prepare.outputs.files_ready }}
      
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Prepare with API Key
        id: prepare
        run: |
          # Crea una cartella temporanea con i file modificati
          mkdir -p ./dist
          cp -r ./* ./dist/ 2>/dev/null || true
          
          # Sostituisci nei file nella cartella dist
          find ./dist -type f \( -name "*.html" -o -name "*.js" \) | while read file; do
            if [ -f "$file" ]; then
              sed -i "s/TMDB_API_KEY_PLACEHOLDER/${{ secrets.MY_KEY }}/g" "$file"
              echo "ğŸ”§ Modificato: $file"
            fi
          done
          
          # Crea un artefatto per la build successiva
          echo "files_ready=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ Cartella 'dist' pronta con API Key inserita"
          
      - name: ğŸ“¦ Upload artifact for next job
        uses: actions/upload-artifact@v3
        with:
          name: site-with-api-key
          path: ./dist
          retention-days: 1
          
      - name: ğŸ“ Info
        run: |
          echo "âœ… File preparati con API Key"
          echo "ğŸ“‚ Artefatto 'site-with-api-key' creato"
          echo "ğŸš€ Ora puoi usare questo artefatto nella tua build principale"
